<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head th:replace="~{fragments/head :: head}"></head>
<body>
<div class="container mt-4">
    <h2>Add new routine</h2>

    <form th:action="@{/workouts/new}" th:object="${workout}" method="post">
        <div class="mb-3">
            <label for="workoutName" class="form-label">Workout Name</label>
            <input
                    type="text"
                    th:field="*{workoutName}"
                    class="form-control"
                    id="workoutName"
                    placeholder="Example: Chest Day"
                    required
            />
        </div>

        <h4>Exercises</h4>
        <div id="exercises-container">

            <div
                    class="exercise-item mb-3 border p-3 rounded"
                    th:each="exercise, stat : *{exercises}"
                    th:data-index="${stat.index}"
            >
                <div class="mb-2">
                    <label class="form-label">Choose an exercise(optional)</label>
                    <select
                            th:field="*{exercises[__${stat.index}__].exerciseId}"
                            class="form-select"
                    >
                        <option value="">-- Optional: existing exercise --</option>
                        <option
                                th:each="ex : ${allExercises}"
                                th:value="${ex.id}"
                                th:text="${ex.name}"
                        ></option>
                    </select>
                </div>

                <div class="mb-2">
                    <label class="form-label">Or add new exercise</label>
                    <input
                            type="text"
                            th:field="*{exercises[__${stat.index}__].newExerciseName}"
                            placeholder="Name of new exercise"
                            class="form-control"
                    />
                </div>

                <div class="row g-2">
                    <div class="col">
                        <label class="form-label">Sets</label>
                        <input
                                type="number"
                                min="1"
                                th:field="*{exercises[__${stat.index}__].sets}"
                                class="form-control"
                                required
                        />
                    </div>
                    <div class="col">
                        <label class="form-label">Reps</label>
                        <input
                                type="number"
                                min="1"
                                th:field="*{exercises[__${stat.index}__].reps}"
                                class="form-control"
                                required
                        />
                    </div>
                    <div class="col">
                        <label class="form-label">Weight (kg)</label>
                        <input
                                type="number"
                                min="0"
                                step="0.1"
                                th:field="*{exercises[__${stat.index}__].weight}"
                                class="form-control"
                        />
                    </div>
                </div>

                <button
                        type="button"
                        class="btn btn-danger btn-sm mt-2 remove-exercise-btn"
                >Remove exercise</button>

            </div>
        </div>

        <button
                type="button"
                id="add-exercise-btn"
                class="btn btn-secondary mb-3"
        >Add exercise</button>

        <div class="d-flex justify-content-end gap-2">
            <button type="submit" class="btn btn-primary">Save</button>
            <button
                    type="button"
                    class="btn btn-secondary"
                    th:onclick="|window.location='@{/workouts}'|"
            >Cancel</button>
        </div>
    </form>
</div>


<div th:replace="~{fragments/bootstrap-js :: bootstrap-js}"></div>

<script>
    const exercisesContainer = document.getElementById('exercises-container');
    const addExerciseBtn    = document.getElementById('add-exercise-btn');

    function updateIndices() {
        exercisesContainer.querySelectorAll('.exercise-item').forEach((item, i) => {
            item.setAttribute('data-index', i);
            item.querySelectorAll('input, select').forEach(el => {
                const name = el.getAttribute('name');
                el.setAttribute('name', name.replace(/\[\d+\]/, '[' + i + ']'));
            });
        });
    }

    addExerciseBtn.addEventListener('click', () => {
        const first = exercisesContainer.querySelector('.exercise-item');
        const clone = first.cloneNode(true);
        clone.querySelectorAll('input').forEach(i => i.value = '');
        clone.querySelector('select').selectedIndex = 0;
        exercisesContainer.appendChild(clone);
        updateIndices();
    });

    exercisesContainer.addEventListener('click', e => {
        if (e.target.classList.contains('remove-exercise-btn')) {
            const items = exercisesContainer.querySelectorAll('.exercise-item');
            if (items.length > 1) {
                e.target.closest('.exercise-item').remove();
                updateIndices();
            } else {
                alert('There must be at least one exercise.');
            }
        }
    });
</script>
</body>
</html>
